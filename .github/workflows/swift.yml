# Swift package build workflow
# Builds XCFramework and tests Swift package on tag
#
# DISABLED: This workflow is currently disabled due to recurring failures.
# To re-enable, uncomment the 'on:' triggers below.
name: Swift

# Disabled - uncomment to re-enable
# on:
#   push:
#     tags:
#       - 'v*'
#       - 'swift-v*'
#   workflow_dispatch:

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "enable" to run this workflow'
        required: true

jobs:
  build-xcframework:
    name: Build XCFramework
    runs-on: macos-14
    if: github.event.inputs.confirm == 'enable'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: |
            aarch64-apple-ios
            aarch64-apple-ios-sim
            x86_64-apple-ios
            aarch64-apple-darwin
            x86_64-apple-darwin

      - name: Build XCFramework
        run: ./scripts/build-xcframework.sh

      - name: Debug - Show patched Swift file
        run: |
          echo "=== First 15 lines of eulumdat_ffi.swift ==="
          head -15 swift/Sources/Eulumdat/eulumdat_ffi.swift
          echo "=== Checking for #if canImport ==="
          grep -n "#if canImport" swift/Sources/Eulumdat/eulumdat_ffi.swift || echo "No #if canImport found (good!)"

      - name: Clean Swift build cache
        working-directory: swift
        run: swift package clean

      - name: Run Swift tests
        working-directory: swift
        run: swift test

      - name: Upload XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: eulumdat_ffiFFI.xcframework
          path: swift/eulumdat_ffiFFI.xcframework

      - name: Upload Swift sources
        uses: actions/upload-artifact@v4
        with:
          name: swift-sources
          path: swift/Sources/Eulumdat/*.swift

  release:
    name: Release Swift Package
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && github.event.inputs.confirm == 'enable'
    needs: build-xcframework
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download XCFramework
        uses: actions/download-artifact@v4
        with:
          name: eulumdat_ffiFFI.xcframework
          path: swift/eulumdat_ffiFFI.xcframework

      - name: Download Swift sources
        uses: actions/download-artifact@v4
        with:
          name: swift-sources
          path: swift/Sources/Eulumdat

      - name: Create XCFramework zip
        run: |
          cd swift
          zip -r eulumdat_ffiFFI.xcframework.zip eulumdat_ffiFFI.xcframework

      - name: Add to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            swift/eulumdat_ffiFFI.xcframework.zip
          append_body: true
          body: |

            ## Swift Package

            Add to your Package.swift:
            ```swift
            .package(url: "https://github.com/holg/eulumdat-rs", from: "${{ github.ref_name }}")
            ```
